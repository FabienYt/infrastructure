#jinja2: trim_blocks: "true", lstrip_blocks: "true"
---
{{ ansible_managed | comment }}
# Generated by Ansible role {{ ansible_role_name }}

global:
  checkNewVersion: false
  sendAnonymousUsage: false

{% if traefik_insecureSkipVerify is defined %}
serversTransport:
  insecureSkipVerify: {{ traefik_insecureSkipVerify | default('false') }}
{% endif %}

ping: {}

experimental:
  http3: true

entryPoints:
  web:
    address: "{{ traefik_web_port | default(':80') }}"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
  websecure:
    address: "{{ traefik_websecure_port | default(':443') }}"
    http3:
      advertisedPort: "{{ traefik_websecure_http3_advertisedPort | default('443') }}"
    http:
      middlewares:
        - compress@file
        - floc@file
        - securedheaders@file
      tls:
        certresolver: ovh
        domains:
        {% if traefik_domain_main is defined %}
        - main: {{ traefik_domain_main }}
        {% else %}
        - main: {{ domain_name }}
          sans: "*.{{ domain_name }}"
        {% endif %}

certificatesResolvers:
  ovh:
    acme:
      email: {{ acme_email }}
      keyType: 'EC384'
      storage: /etc/traefik/acme/acme.json
      dnsChallenge:
        provider: ovh
        delayBeforeCheck: 60
        resolvers:
        {% if traefik_dnsChallenge_resolvers is defined  %}
        {% for resolver in traefik_dnsChallenge_resolvers %}
          - "{{ resolver }}:53"
        {% endfor %}
        {% else %}
          - "{{ hostvars['vm-esxi-network'].ansible_host }}:53"
          - "{{ hostvars['network-server-replica'].ansible_host }}:53"
        {% endif %}

providers:
  docker:
    endpoint: "tcp://traefik-docker-socket-proxy:2375"
    exposedByDefault: false
    network: {{ docker_compose_network_proxy_name }}
  file:
    filename: /etc/traefik/config/dynamic_configuration.yml

pilot:
  dashboard: false
